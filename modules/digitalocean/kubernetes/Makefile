.PHONY: help
.DEFAULT_GOAL := help
help:
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage: make \033[36m<target>\033[0m\n\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-10s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

# Variables
TOFU_CMD := $(shell which tofu)
TOFU_GLOBAL_OPTS =\
	-no-color\
	\

TOFU_OPTS=\
	\

.PHONY: format
# Targets
format: ## Formats code with `fmt -recursive`
	$(TOFU_CMD) fmt -recursive $(TOFU_GLOBAL_OPTS)

.PHONY: validate
validate: format ## Generates a plan with the default.tfvars variable
	$(TOFU_CMD) validate \
		-consolidate-warnings \
		-json \
		$(TOFU_GLOBAL_OPTS)

.PHONY: docs
docs: tflock ## Generate documentation for README.md
	terraform-docs markdown table --output-file README.md .

.PHONY: generate-vars
generate-vars: ## Generates an example default.tfvars file
	terraform-docs tfvars hcl . | tee default.tfvars

.PHONY: init
init: validate  ## Generates a plan with the default.tfvars variable
	$(TOFU_CMD) init -reconfigure \
		-json \
		-input=false \
		-compact-warnings \
		$(TOFU_GLOBAL_OPTS)\

.PHONY: plan-cluster
plan-cluster: ## Plans only cluster and node pools (Stage 1)
	$(TOFU_CMD) plan \
		--var-file default.tfvars \
		-target=digitalocean_kubernetes_cluster.this \
		-target=digitalocean_kubernetes_node_pool.platform \
		-target=digitalocean_kubernetes_node_pool.servers \
		-out tfplan-cluster \
		-input=false \
		-parallelism=10 \
		-concise \
		-compact-warnings \
		$(TOFU_OPTS)

.PHONY: plan
plan: ## Generates a plan with the default.tfvars variable (excludes kubernetes_manifest for initial runs)
	$(TOFU_CMD) plan \
		--var-file default.tfvars \
		-exclude=kubernetes_manifest.letsencrypt_clusterissuer_prod \
		-exclude=kubernetes_manifest.letsencrypt_clusterissuer_staging \
		-out tfplan \
		-input=false \
		-parallelism=10 \
		-concise \
		-compact-warnings \
		$(TOFU_OPTS)

.PHONY: plan-all
plan-all: ## Plans everything including kubernetes_manifest resources (requires cluster to exist)
	$(TOFU_CMD) plan \
		--var-file default.tfvars \
		-out tfplan-all \
		-input=false \
		-parallelism=10 \
		-concise \
		-compact-warnings \
		$(TOFU_OPTS)


.PHONY: apply-cluster
apply-cluster: plan-cluster ## Applies only cluster and node pools (Stage 1)
	$(TOFU_CMD) apply \
		-input=false \
		-auto-approve \
		-consolidate-errors \
		-no-color \
		"tfplan-cluster"

.PHONY: apply
apply: plan ## Applies the plan generated by the plan target (excludes kubernetes_manifest)
	$(TOFU_CMD) apply \
		-input=false \
		-auto-approve \
		-consolidate-errors \
		-no-color \
		"tfplan"

.PHONY: apply-all
apply-all: plan-all ## Applies everything including kubernetes_manifest resources (Stage 2 - requires cluster to exist)
	$(TOFU_CMD) apply \
		-input=false \
		-auto-approve \
		-consolidate-errors \
		-no-color \
		"tfplan-all"

.PHONY: destroy
destroy: ## Applies the plan generated by the plan target
	$(TOFU_CMD) apply \
		-destroy \
		-var-file default.tfvars \
		-input=false \
		-auto-approve \
		-consolidate-errors \
		-no-color \
		-json


emacs-compile:
	$(TOFU_CMD) $(TOFU_OPTS) init -reconfigure -no-color
	$(TOFU_CMD) $(TOFU_OPTS) validate -no-color
	$(TOFU_CMD) $(TOFU_OPTS) apply \
		--var-file default.tfvars \
		-auto-approve=true \
		-no-color \
		-target=digitalocean_kubernetes_cluster.this
	AWS_PROFILE=personal $(TOFU_CMD) $(TOFU_OPTS) plan --var-file default.tfvars -out tfplan $(TOFU_OPTS) -no-color
	AWS_PROFILE=personal $(TOFU_CMD) $(TOFU_OPTS) apply tfplan $(TOFU_OPTS) -no-color

.PHONY: test
test: ## Generates a plan with the default.tfvars variable
	$(TOFU_CMD) $(TOFU_OPTS) init -reconfigure
	$(TOFU_CMD) $(TOFU_OPTS) validate
	$(TOFU_CMD) $(TOFU_OPTS) plan --var-file default.tfvars -out tfplan $(TOFU_OPTS)
	$(TOFU_CMD) $(TOFU_OPTS) apply tfplan $(TOFU_OPTS)
	$(TOFU_CMD) $(TOFU_OPTS) destroy --var-file default.tfvars -auto-approve $(TOFU_OPTS)

.PHONY: cost
cost: ## Calculates costs of the current module
	@infracost breakdown --path .

tflock: ## Generates the lockfile
	$(TOFU_CMD) $(TOFU_OPTS) providers lock \
  -platform=windows_amd64 \
  -platform=darwin_amd64 \
  -platform=darwin_arm64 \
  -platform=linux_amd64 \
  -platform=linux_arm64

.PHONY: provision-init
provision-init: ## Creates the clusters in the correct order for a succesfull provision
	echo "Step 1: Cluster"
	$(TOFU_CMD) apply \
		-target digitalocean_kubernetes_cluster.this \
		--var-file default.tfvars \
		-auto-approve \
		-consolidate-errors \
		-no-color
	# Wait for Kubernetes cluster API to be fully ready
	sleep 20
	echo "Step 2: nginx-ingress and cert-manager"
	AWS_PROFILE=personal $(TOFU_CMD) apply \
		-target helm_release.cert-manager \
		-target helm_release.nginx-ingress \
		--var-file default.tfvars \
		-input=false \
		-auto-approve \
		-consolidate-errors \
		-no-color
	# Wait for cert-manager CRDs and webhook to be ready
	sleep 20
	echo "Step 3: Cluster issuers creation"
	AWS_PROFILE=personal $(TOFU_CMD) $(TOFU_OPTS) apply \
		-target kubernetes_manifest.letsencrypt_clusterissuer_prod \
		-target aws_iam_user_policy.certmanager \
		-target kubernetes_manifest.letsencrypt_clusterissuer_staging \
		--var-file default.tfvars \
		-auto-approve \
		-no-color
	# Wait for ClusterIssuers to be registered and ready
	sleep 20

.PHONY: provision
provision: ## Creates the clusters in the correct order for a succesfull provision
	echo "Step 4: remaining resources"
	AWS_PROFILE=personal $(TOFU_CMD) $(TOFU_OPTS) apply \
		--var-file default.tfvars \
		-auto-approve=true \
		-no-color

open-argocd:
	chromium --ignore-certificate-errors argocd.development.ar &
